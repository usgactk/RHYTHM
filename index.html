<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rhythm - Final Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-color: #a29bfe;
            --accent-color: #6a11cb;
            --secondary-color: #2575fc;
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; background: #05050a;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; font-family: 'Montserrat', sans-serif;
            overflow: hidden; user-select: none; touch-action: none;
        }

        #game-container {
            width: 360px; height: 600px; background: #0f0f1a;
            position: relative; overflow: hidden; border-radius: 20px;
            box-shadow: 0 0 40px var(--neon-color); border: 2px solid #2a2a4a;
            transition: all 0.5s ease;
        }

        #game-container.rock-mode { background: #050505; }

        #top-stats {
            position: absolute; top: 0; width: 100%; height: 60px;
            background: rgba(255, 255, 255, 0.05);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 20; border-bottom: 1px solid var(--neon-color);
            backdrop-filter: blur(5px);
        }

        .sound-selection-menu { display: flex; gap: 10px; margin-bottom: 30px; }
        .sound-option { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .sound-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--neon-color);
            color: #fff; padding: 10px 15px; border-radius: 12px; cursor: pointer;
            font-size: 12px; transition: 0.3s; width: 80px; text-align: center;
        }
        .sound-btn.active { background: var(--neon-color); color: #000; box-shadow: 0 0 15px var(--neon-color); }
        .mode-high-score { font-size: 10px; color: var(--neon-color); opacity: 0.8; }

        .stat-box { text-align: center; color: #fff; }
        .stat-label { font-size: 9px; color: var(--neon-color); letter-spacing: 1px; }
        .stat-value { font-size: 16px; text-shadow: 0 0 10px var(--neon-color); }

        #pause-btn {
            position: absolute; top: 70px; right: 15px; z-index: 40;
            background: rgba(255,255,255,0.1); border: 1px solid var(--neon-color);
            color: white; width: 35px; height: 35px; border-radius: 50%;
            cursor: pointer; display: none; font-size: 14px;
        }

        .line { 
            position: absolute; top: 0; bottom: 0; width: 1px; 
            background: var(--neon-color); opacity: 0.2; z-index: 1; transition: all 0.4s; 
        }

        .rock-mode .line {
            width: 3px; opacity: 1;
            background: linear-gradient(to right, #666, #fff, #666);
            box-shadow: 0 0 8px rgba(255,255,255,0.3);
        }

        .tile {
            position: absolute; width: 90px; height: 150px;
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            border-radius: 4px; z-index: 2; cursor: pointer;
            transition: transform 0.1s, background 0.1s;
        }
        
        .rock-mode .tile { width: 64px; height: 64px; border-radius: 50%; }

        .tile.active { 
            background: #fff !important; 
            box-shadow: 0 0 30px #fff, 0 0 60px var(--neon-color) !important; 
            transform: scale(0.85);
            z-index: 10;
        }

        #main-score {
            position: absolute; top: 120px; width: 100%; text-align: center;
            font-size: 60px; color: #fff; text-shadow: 0 0 15px var(--neon-color);
            z-index: 10; pointer-events: none; opacity: 0.6;
        }

        .particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; z-index: 5; }

        .overlay {
            position: absolute; inset: 0; background: rgba(5, 5, 15, 0.95);
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; z-index: 100; color: #fff; text-align: center;
        }

        button.main-btn {
            padding: 16px 40px; font-size: 18px; font-weight: bold;
            background: linear-gradient(90deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            border: none; color: #fff; border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            transition: 0.3s; font-family: 'Montserrat', sans-serif; margin: 10px;
        }

        #game-over-screen, #pause-screen { display: none; z-index: 200; }
        #lvl-up-toast {
            position: absolute; width: 100%; top: 40%; text-align: center;
            color: #fff; font-size: 40px; font-weight: bold;
            text-shadow: 0 0 20px var(--neon-color); pointer-events: none; z-index: 50; opacity: 0;
        }
        @keyframes floatUp {
            0% { transform: translateY(20px); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-40px); opacity: 0; }
        }
        .show-toast { animation: floatUp 1.2s forwards; }
    </style>
</head>
<body>

    <div id="game-container">
        <div id="top-stats">
            <div class="stat-box"><div class="stat-label">REKOR</div><div id="high-score" class="stat-value">0</div></div>
            <div class="stat-box"><div class="stat-label">SEVİYE</div><div id="level-val" class="stat-value">1</div></div>
            <div class="stat-box"><div class="stat-label">SÜRE</div><div id="timer-val" class="stat-value">0s</div></div>
        </div>

        <button id="pause-btn" onclick="pauseGame()">II</button>
        <div id="main-score">0</div>
        <div id="lvl-up-toast">SEVİYE 2</div>

        <div id="line-0" class="line" style="left: 90px;"></div>
        <div id="line-1" class="line" style="left: 180px;"></div>
        <div id="line-2" class="line" style="left: 270px;"></div>
        <div id="line-extra" class="line" style="display:none;"></div>

        <div id="start-screen" class="overlay">
            <h1 style="color: #fff; margin-bottom: 30px; letter-spacing: 5px;">RHYTHM</h1>
            <div class="sound-selection-menu">
                <div class="sound-option">
                    <div id="btn-piano" class="sound-btn active" onclick="setSound('piano')">PIANO</div>
                    <div class="mode-high-score" id="best-piano">R: 0</div>
                </div>
                <div class="sound-option">
                    <div id="btn-rock" class="sound-btn" onclick="setSound('rock')">ROCK</div>
                    <div class="mode-high-score" id="best-rock">R: 0</div>
                </div>
                <div class="sound-option">
                    <div id="btn-synth" class="sound-btn" onclick="setSound('synth')">SYNTH</div>
                    <div class="mode-high-score" id="best-synth">R: 0</div>
                </div>
            </div>
            <button class="main-btn" onclick="startGame()">OYUNA BAŞLA</button>
        </div>

        <div id="pause-screen" class="overlay">
            <h2>DURAKLATILDI</h2>
            <button class="main-btn" onclick="resumeGame()">DEVAM ET</button>
            <button class="main-btn" onclick="goToMenu()" style="background: #444;">ANA MENÜ</button>
        </div>

        <div id="game-over-screen" class="overlay">
            <h2 style="color: #ff4757;">OYUN BİTTİ</h2>
            <div id="final-score" style="font-size: 50px; margin: 10px 0;">0</div>
            <button class="main-btn" onclick="restartGame()">TEKRAR DENE</button>
            <button class="main-btn" onclick="goToMenu()" style="background: #444;">ANA MENÜ</button>
        </div>
    </div>

    <script>
        const container = document.getElementById('game-container');
        const scoreDisplay = document.getElementById('main-score');
        const levelVal = document.getElementById('level-val');
        const timerVal = document.getElementById('timer-val');
        const highScoreVal = document.getElementById('high-score');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const pauseScreen = document.getElementById('pause-screen');
        const pauseBtn = document.getElementById('pause-btn');
        const toast = document.getElementById('lvl-up-toast');

        const themes = [
            { neon: '#a29bfe', accent: '#6c5ce7', secondary: '#2575fc' },
            { neon: '#00d2ff', accent: '#3a7bd5', secondary: '#00d2ff' },
            { neon: '#55efc4', accent: '#00b894', secondary: '#55efc4' },
            { neon: '#ffeaa7', accent: '#fdcb6e', secondary: '#e17055' },
            { neon: '#ff7675', accent: '#d63031', secondary: '#ff7675' },
            { neon: '#fd79ae', accent: '#e84393', secondary: '#fd79ae' }
        ];

        let audioCtx, currentSoundMode = 'piano';
        const guitarMelody = [164.81, 196.00, 220.00, 164.81, 196.00, 233.08, 220.00];
        const pianoMelody = [329.63, 293.66, 261.63, 293.66, 329.63, 329.63, 329.63, 392.00];
        
        let score = 0, level = 1, speed = 5.5, noteIdx = 0, currentBest = 0;
        let gameActive = false, isPaused = false, activeTiles = [], startTime = 0, elapsedTime = 0, timerInterval;

        function updateBestScoresDisplay() {
            ['piano', 'rock', 'synth'].forEach(mode => {
                const best = localStorage.getItem('neonPiano_' + mode) || 0;
                document.getElementById('best-' + mode).innerText = "R: " + best;
            });
            currentBest = parseInt(localStorage.getItem('neonPiano_' + currentSoundMode) || 0);
            highScoreVal.innerText = currentBest;
        }
        updateBestScoresDisplay();

        function updateTheme() {
            let theme = themes[(level - 1) % themes.length];
            document.documentElement.style.setProperty('--neon-color', theme.neon);
            document.documentElement.style.setProperty('--accent-color', theme.accent);
            document.documentElement.style.setProperty('--secondary-color', theme.secondary);
        }

        function setSound(mode) {
            currentSoundMode = mode;
            document.querySelectorAll('.sound-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('btn-' + mode).classList.add('active');
            
            const l0 = document.getElementById('line-0'), l1 = document.getElementById('line-1'), 
                  l2 = document.getElementById('line-2'), le = document.getElementById('line-extra');

            if (mode === 'rock') {
                container.classList.add('rock-mode');
                l0.style.left = "45px"; l1.style.left = "135px"; l2.style.left = "225px";
                le.style.display = "block"; le.style.left = "315px";
            } else {
                container.classList.remove('rock-mode');
                l0.style.left = "90px"; l1.style.left = "180px"; l2.style.left = "270px";
                le.style.display = "none";
            }
            updateTheme();
            updateBestScoresDisplay();
        }

        function playNote(freq) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
            if (currentSoundMode === 'rock') {
                osc.type = 'sawtooth';
                const dist = audioCtx.createWaveShaper();
                dist.curve = (function(amount) {
                    let k = amount, n = 44100, c = new Float32Array(n);
                    for (let i = 0 ; i < n; ++i ) {
                        let x = i * 2 / n - 1;
                        c[i] = ( 3 + k ) * x * 20 * Math.PI / ( 3 + k * Math.abs(x) );
                    } return c;
                })(400);
                osc.connect(dist); dist.connect(gain);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            } else {
                osc.type = currentSoundMode === 'piano' ? 'triangle' : 'square';
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                osc.connect(gain);
            }
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            gain.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            osc.start(); osc.stop(audioCtx.currentTime + 0.6);
        }

        function spawnTile() {
            if (!gameActive || isPaused) return;
            const tile = document.createElement('div');
            tile.className = 'tile';
            const col = Math.floor(Math.random()*4);
            tile.style.left = currentSoundMode === 'rock' ? (col * 90 + 13) + 'px' : (col * 90) + 'px';
            tile.style.top = '-150px';
            container.appendChild(tile);
            activeTiles.push(tile);

            const move = () => {
                if (!gameActive) { tile.remove(); return; }
                if (!isPaused) {
                    let top = parseFloat(tile.style.top);
                    tile.style.top = (top + speed) + 'px';
                    if (top > 600) {
                        if (activeTiles.includes(tile)) endGame();
                        tile.remove(); return;
                    }
                }
                requestAnimationFrame(move);
            };
            requestAnimationFrame(move);

            const handlePress = (e) => {
                e.preventDefault();
                if (!gameActive || isPaused || tile !== activeTiles[0]) return;
                
                activeTiles.shift();
                tile.classList.add('active');
                
                const currentMelody = currentSoundMode === 'rock' ? guitarMelody : pianoMelody;
                playNote(currentMelody[noteIdx % currentMelody.length]);
                
                createParticles(parseInt(tile.style.left) + (currentSoundMode === 'rock' ? 32 : 45), parseInt(tile.style.top) + (currentSoundMode === 'rock' ? 32 : 75));

                noteIdx++; score++;
                scoreDisplay.innerText = score;

                if (score > currentBest) {
                    currentBest = score;
                    highScoreVal.innerText = currentBest;
                }

                if (score % 20 === 0) updateDifficulty();
                setTimeout(() => tile.remove(), 100);
            };
            tile.onmousedown = handlePress; 
            tile.ontouchstart = handlePress;
        }

        function createParticles(x, y) {
            const color = getComputedStyle(document.documentElement).getPropertyValue('--neon-color');
            for (let i = 0; i < 12; i++) {
                const p = document.createElement('div');
                p.className = 'particle'; 
                p.style.backgroundColor = color;
                p.style.boxShadow = `0 0 10px ${color}`;
                p.style.left = x + 'px'; p.style.top = y + 'px';
                container.appendChild(p);
                const angle = Math.random() * Math.PI * 2, dist = Math.random() * 60 + 20;
                p.animate([{ transform: 'translate(0,0) scale(1)', opacity: 1 }, { transform: `translate(${Math.cos(angle)*dist}px, ${Math.sin(angle)*dist}px) scale(0)`, opacity: 0 }], { duration: 600 }).onfinish = () => p.remove();
            }
        }

        function updateDifficulty() {
            level++;
            levelVal.innerText = level;

            // HIZ MANTIĞI GÜNCELLEMESİ (İstediğin Baremlere Göre)
            if (level === 2) speed = 6.0;
            else if (level === 3) speed = 7.0;
            else if (level === 4) speed = 8.0;
            else if (level === 5) speed = 9.0;
            else if (level === 6) speed = 10.0;
            else if (level === 7) speed = 11.0;
            else if (level >= 8) speed += 0.5; // 7. Seviyeden sonra +0.5 artış

            updateTheme();
            toast.innerText = "SEVİYE " + level;
            toast.classList.remove('show-toast');
            void toast.offsetWidth; 
            toast.classList.add('show-toast');
        }

        function startGame() {
            startScreen.style.display = 'none'; pauseBtn.style.display = 'block';
            gameActive = true; isPaused = false;
            startTime = Date.now() - (elapsedTime * 1000);
            updateTheme(); startTimer(); loop();
        }

        function startTimer() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if (gameActive && !isPaused) {
                    elapsedTime = Math.floor((Date.now() - startTime) / 1000);
                    timerVal.innerText = elapsedTime + "s";
                }
            }, 1000);
        }

        function pauseGame() { if(!gameActive) return; isPaused = true; pauseScreen.style.display = 'flex'; clearInterval(timerInterval); }
        function resumeGame() { isPaused = false; pauseScreen.style.display = 'none'; startTime = Date.now() - (elapsedTime * 1000); startTimer(); }
        
        function goToMenu() {
            gameActive = false; isPaused = false; clearInterval(timerInterval);
            document.querySelectorAll('.tile').forEach(t => t.remove());
            pauseScreen.style.display = 'none'; gameOverScreen.style.display = 'none';
            startScreen.style.display = 'flex'; pauseBtn.style.display = 'none';
            resetStats();
        }

        function resetStats() {
            score = 0; level = 1; speed = 5.5; noteIdx = 0; elapsedTime = 0;
            scoreDisplay.innerText = "0"; levelVal.innerText = "1"; timerVal.innerText = "0s";
            activeTiles = []; updateTheme(); updateBestScoresDisplay();
        }

        function restartGame() { resetStats(); gameOverScreen.style.display = 'none'; startGame(); }
        function loop() {
            if (!gameActive) return;
            if (!isPaused) spawnTile();
            // Notanın gelme sıklığını hızla orantılı ayarla
            let spawnDelay = Math.max(100, 900 - (speed * 60));
            setTimeout(loop, spawnDelay);
        }

        function endGame() {
            gameActive = false; pauseBtn.style.display = 'none'; clearInterval(timerInterval);
            const key = 'neonPiano_' + currentSoundMode;
            if (score > (localStorage.getItem(key) || 0)) localStorage.setItem(key, score);
            document.getElementById('final-score').innerText = score;
            gameOverScreen.style.display = 'flex';
        }
    </script>
</body>
</html>

